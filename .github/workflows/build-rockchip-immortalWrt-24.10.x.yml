name: ðŸ“¦ Build ImmortalWrt Rockchip-24.10.x

on:
  workflow_dispatch:
    inputs:
      luci_version:
        description: "é€‰æ‹©luciç‰ˆæœ¬"
        required: false
        default: "24.10.4"
        type: choice
        options:
          - 24.10.0
          - 24.10.1
          - 24.10.2
          - 24.10.3
          - 24.10.4
      profile:
        type: choice
        description: |
          è¾“å…¥ è½¯è·¯ç”±åž‹å· å¯é€‰å€¼å¦‚ä¸‹ï¼š
        options:
          - ariaboard_photonicat
          - armsom_sige3
          - armsom_sige7
          - cyber_cyber3588-aib
          - ezpro_mrkaio-m68s
          - firefly_roc-rk3328-cc
          - firefly_roc-rk3568-pc
          - friendlyarm_nanopc-t4
          - friendlyarm_nanopc-t6
          - friendlyarm_nanopi-r2c
          - friendlyarm_nanopi-r2c-plus
          - friendlyarm_nanopi-r2s
          - friendlyarm_nanopi-r3s
          - friendlyarm_nanopi-r4s
          - friendlyarm_nanopi-r4se
          - friendlyarm_nanopi-r4s-enterprise
          - friendlyarm_nanopi-r5c
          - friendlyarm_nanopi-r5s
          - friendlyarm_nanopi-r6c
          - friendlyarm_nanopi-r6s
          - huake_guangmiao-g4c
          - lunzn_fastrhino-r66s
          - lunzn_fastrhino-r68s
          - lyt_t68m
          - pine64_rock64
          - pine64_rockpro64
          - radxa_cm3_io
          - radxa_e25
          - radxa_rock-3a
          - radxa_rock-3b
          - radxa_rock-3c
          - radxa_rock-5a
          - radxa_rock-5b
          - radxa_rock-pi-4a
          - radxa_rock-pi-e
          - radxa_rock-pi-s
          - radxa_zero-3e
          - radxa_zero-3w
          - sinovoip_bpi-r2-pro
          - xunlong_orangepi-5
          - xunlong_orangepi-5-plus
          - xunlong_orangepi-r1-plus
          - xunlong_orangepi-r1-plus-lts
        required: true
        default: 'friendlyarm_nanopi-r3s'
      ipaddr:
        description: "è¯·è®¾ç½®è½¯è·¯ç”±çš„ç®¡ç†åœ°å€(æ³¨æ„ä»…å¯¹å¤šç½‘å£è½¯è·¯ç”±æœ‰æ•ˆ) æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.10.1"
      rootfs_partsize:
        description: 'è®¾ç½®è½¯ä»¶åŒ…å¤§å° å•ä½(MB)'
        required: true
        default: '1024'
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: false
      include_docker:
        description: |
          æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
env:
  VERSION: ${{ inputs.luci_version }}
  
jobs:
  build:
    runs-on: ubuntu-22.04
    # å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™ï¼Œè§£å†³ 403 æŠ¥é”™
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: âš™ï¸ è®¾ç½®å¯æ‰§è¡Œæƒé™
        run: chmod +x ${{ github.workspace }}/rockchip/build_config.sh

      - name: ðŸ› ï¸ å®‰è£…ä¾èµ–
        run: |
         sudo apt-get update
         sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev zstd curl unzip tree qemu-utils genisoimage
        
      - name: âš™ï¸ è®¾ç½®IPã€ç½‘å…³å’Œç‰ˆæœ¬å·
        run: |
         CONFIG_PATH="./files/etc/uci-defaults/99-custom.sh"
         echo "å½“å‰ç½‘ç»œé…ç½®è·¯å¾„: $CONFIG_PATH"
        
         # 1. æ›¿æ¢ç‰ˆæœ¬å·å ä½ç¬¦
         sed -i "s/ç‰ˆæœ¬å·/${{ env.VERSION }}/g" "$CONFIG_PATH"
         [ -f "./files/etc/banner" ] && sed -i "s/ç‰ˆæœ¬å·/${{ env.VERSION }}/g" "./files/etc/banner"

         # 2. ç½‘ç»œé€»è¾‘é…ç½® (å…³é”®ä¿®æ”¹ç‚¹ï¼šä¸å†åˆ é™¤è¡Œï¼Œæ”¹ç”¨å…³é”®è¯æ›¿æ¢)
         sed -i "s/__IPADDR__/${{ inputs.ipaddr }}/g" "$CONFIG_PATH"

         # 3. æ›¿æ¢è„šæœ¬æœ«å°¾çš„æè¿°ä¿¡æ¯
         sed -i "s/VERXXXX/${{ env.VERSION }}/g" "$CONFIG_PATH"
        
         echo "âœ… é…ç½®ä¿®æ”¹å®Œæˆï¼Œè¾“å‡ºé¢„è§ˆï¼š"
         cat "$CONFIG_PATH"
            
      - name: Enable Store integration
        run: |
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
            echo "âœ… å·²è¿½åŠ  luci-app-store"
          else
            echo "âŽ æœªå¯ç”¨ luci-app-store"
          fi       

      - name: Building Rockchip ImmortalWrt
        run: |
          profile="${{ github.event.inputs.profile }}"
          include_docker="${{ github.event.inputs.include_docker }}"
          rootfs_partsize="${{ github.event.inputs.rootfs_partsize }}"
          luci_version="${{ github.event.inputs.luci_version }}"
          echo "Building for profile: $profile"
          docker run --rm -i \
              --user root \
              -v "${{ github.workspace }}/bin:/home/build/immortalwrt/bin" \
              -v "${{ github.workspace }}/files:/home/build/immortalwrt/files" \
              -v "${{ github.workspace }}/custom:/home/build/immortalwrt/files/etc/config" \
              -v "${{ github.workspace }}/arch/arch.conf:/home/build/immortalwrt/files/etc/opkg/arch.conf" \
              -v "${{ github.workspace }}/rockchip/imm.config:/home/build/immortalwrt/.config" \
              -v "${{ github.workspace }}/shell:/home/build/immortalwrt/shell" \
              -v "${{ github.workspace }}/rockchip/build_config.sh:/home/build/immortalwrt/build.sh" \
              -e PROFILE=$profile \
              -e INCLUDE_DOCKER=$include_docker \
              -e ROOTFS_PARTSIZE=$rootfs_partsize \
              -e ENABLE_PPPOE=${{ inputs.enable_pppoe }} \
              -e PPPOE_ACCOUNT=${{ inputs.pppoe_account }} \
              -e PPPOE_PASSWORD=${{ inputs.pppoe_password }} \
          immortalwrt/imagebuilder:rockchip-armv8-openwrt-${luci_version} /bin/bash /home/build/immortalwrt/build.sh
        
        - name: âš™ï¸ åŠ¨æ€èŽ·å– Kmod å“ˆå¸Œå¹¶æ›´æ–°é…ç½®
        run: |
         BUILD_VER="${{ env.VERSION }}"
         # ç¡®ä¿åŸºç¡€è·¯å¾„æ­£ç¡®ï¼ˆARM æž¶æž„è·¯å¾„ï¼‰
         BASE_URL="https://downloads.openwrt.org/releases/${BUILD_VER}/targets/armsr/armv8/kmods/"
        
         echo "æ­£åœ¨ä»Ž $BASE_URL èŽ·å–æœ€æ–°çš„å†…æ ¸å“ˆå¸Œ..."
         KMOD_DIR=$(curl -sL $BASE_URL | grep -oE "[0-9.-]+-[a-f0-9]{32}" | head -n 1)
        
         if [ -n "$KMOD_DIR" ]; then
           FULL_KMOD_URL="${BASE_URL}${KMOD_DIR}"
           echo "âœ… æˆåŠŸåŒ¹é… kmods è·¯å¾„: $FULL_KMOD_URL"
          
           # 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
           TARGET_CONF="imagebuilder/repositories.conf"
           if [ ! -f "$TARGET_CONF" ]; then
             echo "âŒ é”™è¯¯: $TARGET_CONF ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ 'å¤åˆ¶å¿…å¤‡æ–‡ä»¶' æ­¥éª¤"
             exit 1
           fi

           # 2. æ›¿æ¢ç‰ˆæœ¬å· (æ”¯æŒå ä½ç¬¦ VERSION_PLACEHOLDER æˆ–ç¡¬ç¼–ç çš„ 24.10.4)
           sed -i "s|VERSION_PLACEHOLDER|${BUILD_VER}|g" "$TARGET_CONF"
           sed -i "s|24.10.4|${BUILD_VER}|g" "$TARGET_CONF"
          
           # 3. æ›¿æ¢ Kmod æ•´è¡Œ (æœ€ç¨³å¦¥ï¼šç›´æŽ¥åŒ¹é…åŒ…å« openwrt_kmods çš„è¡Œå¹¶é‡å†™)
           sed -i "s|^src/gz openwrt_kmods.*|src/gz openwrt_kmods $FULL_KMOD_URL|g" "$TARGET_CONF"
          
           echo "--- æ›´æ–°åŽçš„é…ç½®æ–‡ä»¶å†…å®¹ (é¢„è§ˆ) ---"
           cat "$TARGET_CONF"
         else
           echo "âŒ æ— æ³•èŽ·å– Kmod å“ˆå¸Œï¼Œè¯·æ£€æŸ¥å®˜æ–¹æºæ˜¯å¦å­˜åœ¨è¯¥ç‰ˆæœ¬: $BASE_URL"
           exit 1
         fi  
         
      - name: Create info
        run: |
          cat > ${{ github.workspace }}/router-info.md <<EOF
          ## ðŸ“¡ è·¯ç”±å™¨åŽå°ä¿¡æ¯

          - âœ³ï¸ **è½¯è·¯ç”±åž‹å·**: ${{ github.event.inputs.profile }}
          - ðŸ  **åŽå°åœ°å€**: ${{ github.event.inputs.custom_router_ip }}
          - ðŸ‘¤ **ç”¨æˆ·å**: root
          - ðŸ”‘ **å¯†ç **: æ— 
          EOF

          if [ "${{ github.event.inputs.include_docker }}" == "yes" ]; then
            extra_content="#### é»˜è®¤å¸¦docker"
            echo -e "\n$extra_content" >> ${{ github.workspace }}/router-info.md
          else
            echo -e "\n#### ä¸å¸¦docker" >> ${{ github.workspace }}/router-info.md
          fi

      - name: Upload ImmortWrt as release assets
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: ImmortalWrt-${{ env.VERSION }}-rockship-armv8-RELEASE
          name: ImmortWrt-Rockchip
          body_path: ${{ github.workspace }}/router-info.md
          files: |
            ${{ github.workspace }}/bin/targets/rockchip/armv8/*.img.gz
            ${{ github.workspace }}/bin/targets/rockchip/armv8/sha256sums
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
