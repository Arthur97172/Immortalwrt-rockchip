name: ðŸ“¦ Build ImmortalWrt Rockchip-24.10.x

on:
  workflow_dispatch:
    inputs:
      luci_version:
        description: "é€‰æ‹©luciç‰ˆæœ¬"
        required: false
        default: "24.10.5"
        type: choice
        options:
          - 24.10.0
          - 24.10.1
          - 24.10.2
          - 24.10.3
          - 24.10.4
          - 24.10.5          
      profile:
        type: choice
        description: |
          è¾“å…¥ è½¯è·¯ç”±åž‹å· å¯é€‰å€¼å¦‚ä¸‹ï¼š
        options:
          - all
          - first50
          - range50_100
          - range100_150
          - last20        
          - 9tripod_x3568-v4
          - ariaboard_photonicat
          - armsom_sige3
          - armsom_sige7
          - cyber_cyber3588-aib
          - ezpro_mrkaio-m68s
          - firefly_roc-rk3328-cc
          - firefly_roc-rk3568-pc
          - friendlyarm_nanopc-t4
          - friendlyarm_nanopc-t6
          - friendlyarm_nanopi-r2c
          - friendlyarm_nanopi-r2c-plus
          - friendlyarm_nanopi-r2s
          - friendlyarm_nanopi-r3s
          - friendlyarm_nanopi-r4s
          - friendlyarm_nanopi-r4se
          - friendlyarm_nanopi-r4s-enterprise
          - friendlyarm_nanopi-r5c
          - friendlyarm_nanopi-r5s
          - friendlyarm_nanopi-r6c
          - friendlyarm_nanopi-r6s
          - huake_guangmiao-g4c
          - linkease_easepi-r1
          - lunzn_fastrhino-r66s
          - lunzn_fastrhino-r68s
          - lyt_t68m
          - mmbox_anas3035
          - nlnet_xiguapi-v3         
          - pine64_rock64
          - pine64_rockpro64
          - radxa_cm3-io
          - radxa_e25
          - radxa_e52c
          - radxa_rock-3a
          - radxa_rock-3b
          - radxa_rock-3c
          - radxa_rock-4c-plus
          - radxa_rock-4se
          - radxa_rock-5-itx
          - radxa_rock-5a
          - radxa_rock-5b
          - radxa_rock-5b-plus
          - radxa_rock-5c
          - radxa_rock-5t          
          - radxa_rock-pi-4a
          - radxa_rock-pi-e
          - radxa_rock-pi-s
          - radxa_zero-3e
          - radxa_zero-3w
          - sinovoip_bpi-r2-pro
          - xunlong_orangepi-5
          - xunlong_orangepi-5-plus
          - xunlong_orangepi-r1-plus
          - xunlong_orangepi-r1-plus-lts
        required: true
        default: 'all'
      ipaddr:
        description: "è¯·è®¾ç½®è½¯è·¯ç”±çš„ç®¡ç†åœ°å€(æ³¨æ„ä»…å¯¹å¤šç½‘å£è½¯è·¯ç”±æœ‰æ•ˆ) æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.10.1"
      rootfs_partsize:
        description: 'è®¾ç½®è½¯ä»¶åŒ…å¤§å° å•ä½(MB)'
        required: true
        default: '1024'

env:
  VERSION: ${{ inputs.luci_version }}
  
jobs:
  build:
    runs-on: ubuntu-22.04
    # å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™ï¼Œè§£å†³ 403 æŠ¥é”™
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: âš™ï¸ è®¾ç½®å¯æ‰§è¡Œæƒé™
        run: chmod +x ${{ github.workspace }}/rockchip/build_config.sh

      - name: ðŸ› ï¸ å®‰è£…ä¾èµ–
        run: |
         sudo apt-get update
         sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev zstd curl unzip tree qemu-utils genisoimage
        
      - name: âš™ï¸ è®¾ç½®IPã€ç½‘å…³å’Œç‰ˆæœ¬å·
        run: |
         CONFIG_PATH="./files/etc/uci-defaults/99-custom.sh"
         echo "å½“å‰ç½‘ç»œé…ç½®è·¯å¾„: $CONFIG_PATH"
        
         # 1. æ›¿æ¢ç‰ˆæœ¬å·å ä½ç¬¦
         sed -i "s/ç‰ˆæœ¬å·/${{ env.VERSION }}/g" "$CONFIG_PATH"
         [ -f "./files/etc/banner" ] && sed -i "s/ç‰ˆæœ¬å·/${{ env.VERSION }}/g" "./files/etc/banner"

         # 2. ç½‘ç»œé€»è¾‘é…ç½® (å…³é”®ä¿®æ”¹ç‚¹ï¼šä¸å†åˆ é™¤è¡Œï¼Œæ”¹ç”¨å…³é”®è¯æ›¿æ¢)
         sed -i "s/__IPADDR__/${{ inputs.ipaddr }}/g" "$CONFIG_PATH"

         # 3. æ›¿æ¢è„šæœ¬æœ«å°¾çš„æè¿°ä¿¡æ¯
         sed -i "s/VERXXXX/${{ env.VERSION }}/g" "$CONFIG_PATH"
        
         echo "âœ… é…ç½®ä¿®æ”¹å®Œæˆï¼Œè¾“å‡ºé¢„è§ˆï¼š"
         cat "$CONFIG_PATH"    
        
      - name: â¬ ä¸‹è½½ ImageBuilder
        run: |
         BUILD_VER="${{ env.VERSION }}"
         URL="https://downloads.immortalwrt.org/releases/${BUILD_VER}/targets/rockchip/armv8/immortalwrt-imagebuilder-${BUILD_VER}-rockchip-armv8.Linux-x86_64.tar.zst"
         curl -Lf -o imagebuilder.tar.zst "$URL"
         tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
         mv immortalwrt-imagebuilder-* imagebuilder

      - name: ðŸ”„ å¤åˆ¶å¿…å¤‡æ–‡ä»¶
        run: |
          # 1. é¦–å…ˆåˆ›å»ºæ‰€æœ‰éœ€è¦çš„ç›®å½•å±‚çº§
          mkdir -p imagebuilder/files/etc/uci-defaults
          mkdir -p imagebuilder/files/etc/opkg
          mkdir -p imagebuilder/files/etc/config

          # 2. æ‹·è´åŸºç¡€è„šæœ¬åˆ° imagebuilder æ ¹ç›®å½•
          cp rockchip/build_config.sh imagebuilder/
          cp rockchip/Makefile imagebuilder/
          cp rockchip/repositories.conf imagebuilder/
          cp shell/prepare-packages.sh imagebuilder/
          cp shell/custom-packages.sh imagebuilder/
        
          # 3. æ‹·è´ç³»ç»Ÿé¢„è®¾æ–‡ä»¶
          cp files/etc/uci-defaults/99-custom.sh imagebuilder/files/etc/uci-defaults/
        
          # 4. æ‹·è´è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å¤¹ (custom/ -> /etc/config/)
          [ -d "custom" ] && cp -r custom/* imagebuilder/files/etc/config/ 2>/dev/null || true

          # 5. æ‹·è´è‡ªå®šä¹‰è½¯ä»¶æº (feeds)
          cp -r files/customfeeds/* imagebuilder/files/etc/opkg/ 2>/dev/null || true
        
          # 6. éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "--- éªŒè¯æ‹·è´ç»“æžœ ---"
          [ -f "imagebuilder/build_config.sh" ] && echo "âœ… build_config.sh å‡†å¤‡å°±ç»ª"
          [ -f "imagebuilder/files/etc/uci-defaults/99-custom.sh" ] && echo "âœ… 99-custom.sh å‡†å¤‡å°±ç»ª"
          [ -f "imagebuilder/files/etc/opkg/customfeeds.conf" ] && echo "âœ… customfeeds.conf å‡†å¤‡å°±ç»ª" || echo "âš ï¸ customfeeds.conf æœªæ‰¾åˆ°"
        
      - name: âš™ï¸ åŠ¨æ€èŽ·å– Kmod å“ˆå¸Œå¹¶æ›´æ–°é…ç½®
        run: |
          BUILD_VER="${{ env.VERSION }}"
          # ç¡®ä¿è¿™é‡Œçš„è·¯å¾„ä¹Ÿæ˜¯ rockchip/armv8
          BASE_URL="https://downloads.immortalwrt.org/releases/${BUILD_VER}/targets/rockchip/armv8/kmods/"
        
          echo "æ­£åœ¨ä»Ž $BASE_URL èŽ·å–æœ€æ–°çš„å†…æ ¸å“ˆå¸Œ..."
          # èŽ·å–å¸¦ hash çš„ç›®å½•åï¼Œä¾‹å¦‚ 6.6.110-1-xxxx...
          KMOD_DIR=$(curl -sL $BASE_URL | grep -oE "[0-9.-]+-[a-f0-9]{32}" | head -n 1)
        
          if [ -n "$KMOD_DIR" ]; then
            FULL_KMOD_URL="${BASE_URL}${KMOD_DIR}"
            TARGET_CONF="imagebuilder/repositories.conf"
            
            # 1. æ›¿æ¢ç‰ˆæœ¬å ä½ç¬¦
            sed -i "s|VERSION_PLACEHOLDER|${BUILD_VER}|g" "$TARGET_CONF"
            # 2. æ›¿æ¢ KMOD å ä½ç¬¦
            sed -i "s|KMOD_PLACEHOLDER|${FULL_KMOD_URL}|g" "$TARGET_CONF"
            
            echo "âœ… è½¯ä»¶æºé…ç½®æ›´æ–°å®Œæ¯•"
          else
            echo "âŒ æ— æ³•èŽ·å– Kmod å“ˆå¸Œï¼Œè¯·æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å‘å¸ƒ"
            exit 1
          fi
          echo "--- æ£€æŸ¥æ›´æ–°åŽçš„ repositories.conf ---"
          cat imagebuilder/repositories.conf | grep "https"


      - name: ðŸ§± æž„å»ºImmortalWrtå›ºä»¶
        working-directory: ./imagebuilder
        run: |
          # æŒ‰ç…§è„šæœ¬éœ€è¦çš„é¡ºåºä¼ å…¥ï¼šåž‹å·ã€å¤§å°
          bash ./build_config.sh "${{ inputs.profile }}" "${{ inputs.rootfs_partsize }}"
         
      - name: ðŸ“œ ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        run: |
          cat > ${{ github.workspace }}/router-info.md <<EOF
          ## ðŸ“¡ è·¯ç”±å™¨åŽå°ä¿¡æ¯
          
          ðŸ  åŽå°åœ°å€ï¼š ${{ github.event.inputs.ipaddr }}
          ðŸ‘¤ ç”¨æˆ·åï¼š root
          ðŸ”‘ å¯†ç ï¼š æ— 
          EOF

      - name: ðŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: ImmortalWrt-${{ env.VERSION }}-rockship-armv8-RELEASE
          #name: ImmortWrt-Rockchip
          body_path: ${{ github.workspace }}/router-info.md
          overwrite: true
          files: |
            imagebuilder/bin/targets/rockchip/armv8/*.img.gz
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
